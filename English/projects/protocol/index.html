



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Loopring - Decentralized Token Exchange Protocol">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.2.2">
    
    
      
        <title>Protocol - Loopring Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.7a4cdee3.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.792431c1.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    
  </head>
  
    
    
    
      <body data-md-color-primary="green" data-md-color-accent="deep-orange">
    
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Loopring Documentation" class="md-header-nav__button md-logo">
          
            <img src="../../../img/logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Loopring Documentation
              </span>
              <span class="md-header-nav__topic">
                Protocol
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/Loopring/documents/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." title="Loopring" class="md-tabs__link">
        Loopring
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../overview/" title="English" class="md-tabs__link md-tabs__link--active">
          English
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../Japanese/overview/" title="日本語" class="md-tabs__link">
          日本語
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../Korean/overview/" title="한국어" class="md-tabs__link">
          한국어
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../../img/logo.svg" width="24" height="24">
      
    </span>
    Loopring Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/Loopring/documents/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Loopring" class="md-nav__link">
      Loopring
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      English
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        English
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../token/" title="LRC Token" class="md-nav__link">
      LRC Token
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Protocol
      </label>
    
    <a href="./" title="Protocol" class="md-nav__link md-nav__link--active">
      Protocol
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#management-of-orders" title="Management of Orders" class="md-nav__link">
    Management of Orders
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anatomy-of-an-order" title="Anatomy of an Order" class="md-nav__link">
    Anatomy of an Order
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-or-partial-cancellation" title="Full or Partial Cancellation" class="md-nav__link">
    Full or Partial Cancellation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fill-and-cancellation-tracking" title="Fill and Cancellation Tracking" class="md-nav__link">
    Fill and Cancellation Tracking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verification-of-miner-supplied-data" title="Verification of Miner Supplied Data" class="md-nav__link">
    Verification of Miner Supplied Data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#order-ring" title="Order Ring" class="md-nav__link">
    Order Ring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-ring-validation" title="Order Ring Validation" class="md-nav__link">
    Order Ring Validation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sub-loop-checking" title="Sub-Loop Checking" class="md-nav__link">
    Sub-Loop Checking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fill-rate-checking" title="Fill Rate Checking" class="md-nav__link">
    Fill Rate Checking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-scaling" title="Order Scaling" class="md-nav__link">
    Order Scaling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ring-settlement" title="Ring Settlement" class="md-nav__link">
    Ring Settlement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transactions" title="Transactions" class="md-nav__link">
    Transactions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fee-model" title="Fee Model" class="md-nav__link">
    Fee Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#emitted-events" title="Emitted Events" class="md-nav__link">
    Emitted Events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fraud-and-attack-protections" title="Fraud and Attack Protections" class="md-nav__link">
    Fraud and Attack Protections
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ring-filch" title="Ring Filch" class="md-nav__link">
    Ring Filch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#denial-of-service" title="Denial of Service" class="md-nav__link">
    Denial of Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#massive-tiny-order-attack" title="Massive Tiny Order Attack" class="md-nav__link">
    Massive Tiny Order Attack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-balance" title="Insufficient Balance" class="md-nav__link">
    Insufficient Balance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relay/" title="Relays" class="md-nav__link">
      Relays
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../wallet/" title="Wallets" class="md-nav__link">
      Wallets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tokenization/" title="Tokenization Services" class="md-nav__link">
      Tokenization Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../contribution/" title="Contribution" class="md-nav__link">
      Contribution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      日本語
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        日本語
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Japanese/overview/" title="概要" class="md-nav__link">
      概要
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Japanese/projects/protocol/" title="契約" class="md-nav__link">
      契約
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      한국어
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        한국어
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Korean/overview/" title="개요" class="md-nav__link">
      개요
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#management-of-orders" title="Management of Orders" class="md-nav__link">
    Management of Orders
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anatomy-of-an-order" title="Anatomy of an Order" class="md-nav__link">
    Anatomy of an Order
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-or-partial-cancellation" title="Full or Partial Cancellation" class="md-nav__link">
    Full or Partial Cancellation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fill-and-cancellation-tracking" title="Fill and Cancellation Tracking" class="md-nav__link">
    Fill and Cancellation Tracking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verification-of-miner-supplied-data" title="Verification of Miner Supplied Data" class="md-nav__link">
    Verification of Miner Supplied Data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#order-ring" title="Order Ring" class="md-nav__link">
    Order Ring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-ring-validation" title="Order Ring Validation" class="md-nav__link">
    Order Ring Validation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sub-loop-checking" title="Sub-Loop Checking" class="md-nav__link">
    Sub-Loop Checking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fill-rate-checking" title="Fill Rate Checking" class="md-nav__link">
    Fill Rate Checking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-scaling" title="Order Scaling" class="md-nav__link">
    Order Scaling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ring-settlement" title="Ring Settlement" class="md-nav__link">
    Ring Settlement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transactions" title="Transactions" class="md-nav__link">
    Transactions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fee-model" title="Fee Model" class="md-nav__link">
    Fee Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#emitted-events" title="Emitted Events" class="md-nav__link">
    Emitted Events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fraud-and-attack-protections" title="Fraud and Attack Protections" class="md-nav__link">
    Fraud and Attack Protections
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ring-filch" title="Ring Filch" class="md-nav__link">
    Ring Filch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#denial-of-service" title="Denial of Service" class="md-nav__link">
    Denial of Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#massive-tiny-order-attack" title="Massive Tiny Order Attack" class="md-nav__link">
    Massive Tiny Order Attack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insufficient-balance" title="Insufficient Balance" class="md-nav__link">
    Insufficient Balance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Loopring/documents/edit/master/docs/English/projects/protocol.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="loopring-smart-contracts">Loopring Smart Contracts</h1>
<p>The loopring smart contracts are a set of ethereum contracts that implement the loopring protocol. This document describes the functionalities they provide and is structured as follows:</p>
<p>The code is open source and available on <a href="https://github.com/Loopring/protocol">github</a>.</p>
<p>The Loopring Smart Contracts will be referred to as <code class="codehilite">LSC</code> in this document. You can read more about the calculations and formulas used here in the <a href="https://github.com/Loopring/whitepaper/raw/master/en_whitepaper.pdf">whitepaper</a> and supersimmetry's {<a href="mailto:da447m@yahoo.com">da447m@yahoo.com</a>} <a href="../../pdf/supersimmetry-loopring-remark.pdf">Remarks on Loopring</a>. Please note that in the current protocol implementation, the pricing model is the same as in our whitepaper and supersimmetry's document, but the fee model is different.</p>
<h2 id="management-of-orders">Management of Orders</h2>
<p>To understand what the LSC does, we must first take a look at the definition of an order, the available actions for the user, and how the current order state is tracked.</p>
<h3 id="anatomy-of-an-order">Anatomy of an Order</h3>
<p>An order is a pack of data that describes the intent of the user on the market. To ensure the origin of the order, it is <code class="codehilite">signed against the hash of its parameters</code> with the user's private key. The signature is sent alongside the order on the network. This requires the order to stay <code class="codehilite">immutable</code> during its whole lifetime to verify the sender's address.<br/>
<code class="codehilite">Signature = ECDSA(SHA3(order_params))</code></p>
<p>Even if the order never changes, the LSC has the possibility to <a href="./#transactions">compute its current state</a>.</p>
<p>Relevant variables of an order's parameters (for a complete list of order parameters, see <a href="https://github.com/Loopring/protocol/blob/ef5290d59daa7be4eee450b215d6a50ca9d3492d/contracts/LoopringProtocol.sol#L39">the code</a>):</p>
<table>
<thead>
<tr>
<th>Data</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>owner</td>
<td>The owner (signer) address</td>
</tr>
<tr>
<td>tokenS</td>
<td>Token to sell</td>
</tr>
<tr>
<td>tokenB</td>
<td>Token to buy</td>
</tr>
<tr>
<td>amountS</td>
<td>Amount of tokenS to sell</td>
</tr>
<tr>
<td>amountB</td>
<td>Amount of tokenB to buy</td>
</tr>
<tr>
<td>buyNoMoreThanAmountB</td>
<td>see below</td>
</tr>
<tr>
<td>ttl</td>
<td>(time to live) Seconds after wich the order will expire</td>
</tr>
<tr>
<td>lrcFee</td>
<td>Max amount of LRC to pay to the miner</td>
</tr>
<tr>
<td>marginSplitPercentage</td>
<td>The percentage of margin paid to the miner (when a better rate is found)</td>
</tr>
</tbody>
</table>
<p>We called the above model <strong>Unidirectional Order Model</strong>, or UDOM for short. To learn more about UDOM, check out our <a href="https://medium.com/@loopring/looprings-uni-directional-order-model-510067377fe9">medium post</a>.</p>
<p>The exchange rate <code class="codehilite">r</code> of the order is determined using the following formula <code class="codehilite">r = amountS/amountB</code>. When a miner does the ring-matching there is a possibility that he finds you a better rate that gets you more <code class="codehilite">tokenB</code> than the <code class="codehilite">amountB</code> you specified. But, if the <code class="codehilite">buyNoMoreThanAmountB</code> flag is set, the LSC will make sure that you still get exactly <code class="codehilite">amountB</code> of <code class="codehilite">tokenB</code>.</p>
<blockquote>
<p><strong>Example</strong>: with <code class="codehilite">amountS = 10</code> and <code class="codehilite">amountB = 2</code>, <code class="codehilite">r = 10/2 = 5</code>. This means that you are willing to sell <code class="codehilite">5 tokenS for each tokenB</code>. The miner does the ring-matching and <code class="codehilite">finds you a rate of 4</code>, topping the amount he could get you to <code class="codehilite">2.5 tokensB instead of 2</code>. You only wanted 2 tokensB and set the <code class="codehilite">buyNoMoreThanAmountB flag to true</code>. The LSC takes that into consideration and still makes the transaction at a rate of 4 and you ended up selling <code class="codehilite">4 tokenS for each tokenB</code>, effectively <code class="codehilite">saving 2 tokenS</code>. Keep in mind that this does not take into account the miner fees.</p>
</blockquote>
<h3 id="full-or-partial-cancellation">Full or Partial Cancellation</h3>
<p>A user can partially or fully cancel an order by sending a special transaction to the LSC, containing the details about the order and the amounts to cancel. The LSC will take that into account, store the amounts to cancel and emit an <code class="codehilite">OrderCancelled</code> event to the network.</p>
<h3 id="fill-and-cancellation-tracking">Fill and Cancellation Tracking</h3>
<p>The LSC keeps track of fill and cancellation amounts by storing their values using the order's hash as an identifier. This data is publicly accessible and <code class="codehilite">OrderCancelled</code> / <code class="codehilite">OrderFilled</code> events are emitted when it changes.</p>
<p>This tracking is useful for the LSC during the <a href="./#ring-settlement">ring settlement</a> step.</p>
<h2 id="verification-of-miner-supplied-data">Verification of Miner Supplied Data</h2>
<p>This section will talk about what the LSC expect to receive from the miners and the steps taken to verify the data.</p>
<h3 id="order-ring">Order Ring</h3>
<p>The LSC expect to receive order rings from the miners. An order ring is multiple orders linked together in a way that allows them to be all matched at their desired exchange rate or better. See the diagram below as an example.</p>
<p><img alt="" src="../../../img/diagrams/order-ring.png" /></p>
<p>Notice how each order's token to sell is the following order's token to buy. It creates a loop that allows each order to effectively sell and buy their desired tokens without having a matching order of the opposite pair.</p>
<p>A ring is said to be valid when all the transactions can be made at an exchange rate equal or better than the original one specified by the user.
To verify the ring validity, the product of the original exchange rates of all orders should be equal to or greater than 1.</p>
<blockquote>
<p><strong>Example</strong>: Let's check if the above ring in the diagram is valid.
<code class="codehilite">0.2 * 14 * 0.5 = 1.4</code> the result is greater than 1, thus the trade should be possible.</p>
</blockquote>
<h3 id="order-ring-validation">Order Ring Validation</h3>
<p>The LSC does not perform the exchange rate or amount calculations but still has to verify what the miner supplied for these values. This is done by miners for two main reasons: solidity does not have support for floating point maths, especially <code class="codehilite">pow(x, 1/n)</code> and it is desired that the computation is made off-chain to save gas.</p>
<p>The following section discusses mathematical validation of the order rings. We recommend you to check supersimmetry's complementary document listed at the beginning of this page.</p>
<h4 id="sub-loop-checking">Sub-Loop Checking</h4>
<p>This step prevents <a href="https://en.wikipedia.org/wiki/Covered_interest_arbitrage">covered interest arbitrage</a>. Once a valid ring is found by a miner, he could be tempted to add other orders to it to achieve a zero-risk covered interest arbitrage.
This is considered unfair conduct from the miner in Loopring.</p>
<p>The diagram below illustrates the previous valid ring where 2 orders were added.
<img alt="" src="../../../img/diagrams/order-ring-sub-loop.png" /></p>
<p>To prevent this, Loopring requires that <strong>a valid loop cannot contain a sub-loop</strong>. There is a very simple way to check this: a <code class="codehilite">token cannot be twice in a buy or sell position</code>. In the above diagram we can see that ARK is twice as a token to sell and twice as a token to buy.</p>
<h3 id="fill-rate-checking">Fill Rate Checking</h3>
<p>The rates calculation for the transactions in the ring are made by the miners for the reasons stated above in this page. Therefore the LSC have to verify that they are correct.</p>
<p>This first verifies that the sell rate the miner supplied for each order is at least equal or less than the original sell rate set by the user. Meaning that the user gets at least the exchange rate he asked for or better at the moment of the transaction.</p>
<p>Once the exchange rates are confirmed, we make sure that all the margins (discounts) are at the same percentage for every order, to ensure fairness.</p>
<h3 id="order-scaling">Order Scaling</h3>
<p>This is the part where the orders are scaled according to:
- The history of filled and cancelled amounts
- The current balance of the senders' accounts</p>
<p>The process finds the order with the smallest amount to be filled according to the above characteristics and uses it as a reference for scaling all the transactions in the ring.</p>
<blockquote>
<p><strong>Example</strong>: If the smallest amount to be filled compared to the original order is 5%, all the transactions in the ring are scaled down to 5%. Once the transactions are completed, the order that was considered to have the smallest amount remaining to be filled should be completely filled.</p>
</blockquote>
<h2 id="ring-settlement">Ring Settlement</h2>
<p>If all the lights are green from the previous checks, the transactions can be made.</p>
<h3 id="transactions">Transactions</h3>
<p>To make the transactions, the LSC uses the <code class="codehilite">TokenTransferDelegate</code> smart contract. The introduction of such a delegate makes upgrading the protocol smart contract easier as all orders only need to authorize this delegate instead of different versions of the protocol.</p>
<p>For each order in the ring, a payment of tokenS is made to the following order. Then the miner's fee is paid depending on the fee model chosen by the miner. If the model was the LRC fee, the remaining amount after the fee is paid is returned to the order's owner. Finally, an <code class="codehilite">OrderFilled</code> event is fired.</p>
<p>Once all the transaction are made, a <code class="codehilite">RingMined</code> event is fired.</p>
<h3 id="fee-model">Fee Model</h3>
<p>This section describes the current fee model of Loopring. As complementary material, we advise you to read Daniel's <a href="https://medium.com/@loopring/remarks-on-looprings-fee-model-7b6713f59fb7">medium article</a> on the subject.</p>
<p>In the current fee model, the miner has two possible choices.
When a user creates his order, he specifies a maximum of LRC to be paid to the miner as a fee, as well as a percentage of the margin made on his order that the miner can claim. This is called the margin split. The decision of which one to choose is left to the miner.</p>
<p>A representation of the margin split:</p>
<p><img alt="" src="../../../img/diagrams/margin-split.png" /></p>
<p>If the miner decides that the margin on the ring is too small, he will choose the LRC fee. On the contrary, if the margin is substantial enough for the resulting margin split to be worth more than the LRC fee, he will choose the margin split.</p>
<p>But here comes the twist. When the miner chooses the margin split, he has to pay the user a fee, which is equal to what the user would have paid as a fee to the miner for his transaction. This increases the threshold where the miner will choose the margin split to twice the LRC fee of the order, adding weight to the LRC fee choice.</p>
<p>From the miner's point of view, this allows him to get a constant income on low margin rings with the drawback of getting less income from the higher margin rings. As the market grows and becomes more mature, we expect to have less high margin rings and our fee model is based on that future.</p>
<p>We end up with the following graph:</p>
<p><img alt="" src="../../../img/fee-model.png" /></p>
<ul>
<li>f is the LRC fee</li>
<li>x is the margin split</li>
<li>y is the miner's income</li>
</ul>
<p>If <code class="codehilite">f</code> is the LRC fee and <code class="codehilite">x</code> the Margin Split, then the miner's income <code class="codehilite">y</code> is <code class="codehilite">y = max(f, x-f)</code> and we get the blue line.</p>
<p>If the specified LRC fee for the order is 0, the equation is <code class="codehilite">y = max(0, x - 0)</code> that simplifies to <code class="codehilite">y = x</code> and we get the orange line.</p>
<p>This has the following consequences:
- If the <code class="codehilite">margin split is 0</code>, the miners will choose the flat LRC fee and are still incentivized.
- If the <code class="codehilite">LRC fee is 0</code>, this is the orange line and the income is based on a general model.
- When the <code class="codehilite">margin split income</code> get's bigger than <code class="codehilite">twice the LRC fee</code>, only then will the miner choose the margin split.</p>
<p>It should be noted that if the <code class="codehilite">LRC fee is non-zero</code>, no matter which option the miner chooses, there will always be a transfer of LRC between the miner and the order's sender. Either by sending back the surplus of LRC fee or by paying the LRC fee to the sender to take the margin split.</p>
<p>The current fee model is still open for discussion. Feel free to join our community on <a href="https://loopring.now.sh/">slack</a> to talk about it. Suggestions are welcomed to the <a href="https://github.com/Loopring/LIPs">LIPs</a> repository on github.</p>
<h2 id="emitted-events">Emitted Events</h2>
<p>In this page you should have come by a set of events that are emitted by the LSC. These events exist to allow the relays/order browsers and other elements that need an update of their orderbooks to get the information as quickly as possible.</p>
<p>A list of the emitted events:
* <code class="codehilite">OrderCancelled</code>
* <code class="codehilite">OrderFilled</code>
* <code class="codehilite">RingMined</code></p>
<h2 id="fraud-and-attack-protections">Fraud and Attack Protections</h2>
<h3 id="ring-filch">Ring Filch</h3>
<p>An attacker could monitor all unconﬁrmed Rings and broadcast the same rings with their own digital signature. We call this Ring Filch. In order to prevent Ring Filch, Loopring allows miners to use two steps in order to submit their Rings:</p>
<ul>
<li>Submit the hash of the Ring and wait for confirmation</li>
<li>Submit the Ring itself</li>
</ul>
<p>This protection is valid for a <code class="codehilite">blocksToLive</code> time specified in the LSC. After that duration, if the ring has not been submitted, an other miner can claim it.</p>
<h3 id="denial-of-service">Denial of Service</h3>
<p>We allow nodes to selectively handle orders by setting their own criteria and they may choose to hide or reveal them. Therefore we do not see denial of service as a form of unethical behaviour.</p>
<h3 id="massive-tiny-order-attack">Massive Tiny Order Attack</h3>
<p>A user could send a large amount of tiny orders to attack the Loopring nodes. However, since we allow nodes to reject orders based on their own criteria, most of these orders will be rejected because they do not yield satisfying profit when matched. Thus, a massive tiny order attack is not feasible.</p>
<h3 id="insufficient-balance">Insufficient Balance</h3>
<p>Malicious users may sign and spread out orders whose value inside the order is not zero but whose address actually has zero balance. Nodes could monitor and notice that some orders actual balance is zero, update these orders states accordingly and then discard them.</p>
<p>Nodes do have to spend time to update the status of an order, but can also choose to minimize the effort by, for example, blacklisting addresses and drop related orders.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../token/" title="LRC Token" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                LRC Token
              </span>
            </div>
          </a>
        
        
          <a href="../relay/" title="Relays" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Relays
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/Loopring" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/loopringorg" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://t.me/loopringinternational" class="md-footer-social__link fa fa-telegram"></a>
    
      <a href="medium.com/loopring-protocol" class="md-footer-social__link fa fa-medium"></a>
    
      <a href="https://loopring.rocket.chat/" class="md-footer-social__link fa fa-slack"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.6cdc17f0.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>